<!DOCTYPE html>
<html lang="eng">

<head>

<meta charset="utf-8">
<title> Australian Zipdecoder </title>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="queue.min.js"></script>

<style type="text/css">
/* HTML styling */
html { background-color: #333333 }
body {
    font-family: Helvetica, Arial, sans-serif; font-size: 16px;
    color: #cbcbcb;
}
a { text-decoration: none; color: #999a63 }
#map { width: 1200px; height: 600px; }

/* SVG styling */
svg { background-color: #333333 }
text { fill: #cbcbcb; font-size: 24px; }
#states { fill: none; stroke: #555555; }
rect { stroke: none; }
.selected { fill: #B9C9D4 }
.unselected { fill: #999a63 }
</style>
</head>
<body>
  <center>
  <div id="map"></div>
  <p style="padding-top: 70px; font-size: 120%">
      Enter a postal code
  </p>
  <label>
    Disable zoom
    <input name="zoom" type="checkbox" />
  </label>
  <p>An australian version of
      <a href="http://benfry.com/">Ben Fry</a>'s
      <a href="http://benfry.com/zipdecode/">zipdecode</a><br>
  </p>
</center>

<script type="text/javascript">

// Display: configurable parameters (see also HTML)
var width = 1200, height = 700;
var instructions = "";

// Display: geographic projection
var proj = d3.geo.mercator()
    .scale(950)
    .translate([-1625, -150]);
var path = d3.geo.path().projection(proj);

// Interaction: stored state
var selectedZip = "";

// Display: AJAX load the data files, then call render()
queue()
    .defer(d3.json, "au-states.geojson")
    .defer(d3.tsv, "auszipcent.tsv")
    .await(render);

// Interaction: handle keyboard input
function key() {
        var code = d3.event.keyCode;

        if (code == 32) {
            // Space: clear code
            updateSelection("");
        } else if (code == 37 || code == 8) {
            // Backspace / left arrow: remove one number
            if (selectedZip.length > 0) {
                updateSelection(selectedZip.substr(0, selectedZip.length - 1));
            }
            // Prevent the browser from going back in the URL history
            d3.event.preventDefault();
        } else if (code >= 48 && code <= 57) {
            // number keys
            appendToSelection(String.fromCharCode(code))
        } else if (code >= 96 && code <= 105) {
            // numeric keypad
            appendToSelection(String.fromCharCode(code-48));
        }
    };
    // Interaction: add a single digit to the zip if possible
    function appendToSelection(digit) {
        if (selectedZip.length < 5) {
            updateSelection(selectedZip + "" + digit);
        }
    }

    // Data: is the given zip code in the selection?
    function zipSelected(zip) {
        var l = selectedZip.length;
        return l > 0 && zip.substr(0, l) == selectedZip;
    }

    // Interaction: update the selected zip code
    function updateSelection(n) {
        selectedZip = n;
        var l = selectedZip.length;

        // Set the text label
        var t = l > 0 ? selectedZip : instructions;
        d3.select("#selected").text(t);

        var start = Date.now();

        // Recolor all the zip dots. Sadly this is slow, a transition won't work
        var dots = d3.select('#zipdots').selectAll('rect')
        var selected = dots
          .classed('selected', false)
          .classed('unselected', true)
          .filter(function(d) { return zipSelected(d.zip) })
            .classed('unselected', false)
            .classed('selected', true)

        var coords = selected[0].map(function(d) {
          return proj([
            +d.__data__.lon,
            +d.__data__.lat,
          ])
        })

        if (zoomEnabled && coords.length) {
          zoomIn(getBBox(coords), dots)
        } else {
          zoomOut(dots)
        }

        console.log("Update dots: " + (Date.now() - start) + "ms");
    }

    function zoomIn(bounds, dots) {
      var dx = bounds[1][0] - bounds[0][0] + 1e-10
      var dy = bounds[1][1] - bounds[0][1] + 1e-10
      var x = (bounds[0][0] + bounds[1][0]) / 2
      var y = (bounds[0][1] + bounds[1][1]) / 2
      var scale = Math.min(400, .9 / Math.max(dx / width, dy / height))
      var translate = [width / 2 - scale * x, height / 2 - scale * y]

      map.transition()
          .duration(750)
          .attr("transform", "translate(" + translate + ")scale(" + scale + ")")
          .attr('stroke-width', 0.5 / scale)

      dots.transition()
          .duration(750)
          .attr('width', 2 / scale)
          .attr('height', 2 / scale)
          .filter('.selected')
            .attr('width', 3 / scale)
            .attr('height', 3 / scale)
    }

    function zoomOut(dots) {
      map.transition()
          .duration(750)
          .attr("transform", "scale(1)")
          .attr('stroke-width', 0.5)

      dots.transition()
          .duration(750)
          .attr('width', 1.5)
          .attr('height', 1.5)
    }

    function getBBox (coords) {
      return coords.reduce((a, b) => ([
          [Math.min(b[0], a[0][0]), Math.min(b[1], a[0][1])],
          [Math.max(b[0], a[1][0]), Math.max(b[1], a[1][1])],
      ]), [
          [Infinity, Infinity],
          [-Infinity, -Infinity],
      ])
    }

    var map
    // Display: create the SVG, draw the map
    function render(error, states, zips) {
        // Display: the main SVG container
        var svg = d3.select("#map").append("svg")
            .attr("width", width)
            .attr("height", height);

        // Interaction: text box displaying the selection
        svg.append("text").attr("id", "selected")
            .text(instructions)
            .attr("x", 20).attr("y", 50);

        map = svg.append("g")
          .attr('stroke-width', 0.5)

        // Display: state outlines
        map.append("g").attr("id", "states")
        d3.select("#states").selectAll("path")
            .data(states.features)
          .enter().append("path")
            .attr("d", path);

        var start = Date.now();

        // Display: all the dots for zip code centroids
        map.append("g").attr("id", "zipdots");
        d3.select("#zipdots").selectAll("rect")
            .data(zips)
          .enter().append("rect")
            .attr("x", function(d) { var p = proj([d.lon, d.lat]); return p ? p[0] : null; })
            .attr("y", function(d) { var p = proj([d.lon, d.lat]); return p ? p[1] : null; })
            .attr("class", "unselected")
            .attr("width", 1.5).attr("height", 1.5);

        console.log("Draw dots: " + (Date.now() - start) + "ms");

        // Interaction: handle keyboard events (keydown to capture backspace)
        d3.select("body").on("keydown", key);
    };

var zoomCheckbox = d3.select('[name=zoom]')
var zoomEnabled = true
zoomCheckbox.on('change', function() {
  zoomEnabled = !zoomCheckbox.node().checked
  updateSelection(selectedZip)
})

</script>

</body>
